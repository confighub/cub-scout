#!/bin/bash
# CCVE-BOW Attack Test Harness
# Applies attacks, runs detection, classifies results
#
# Usage: ./run-attacks.sh [--apply] [--scan] [--report]

set -e

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
AGENT_DIR="$(cd "$SCRIPT_DIR/../.." && pwd)"
ATTACKS_DIR="$SCRIPT_DIR"
RESULTS_FILE="$SCRIPT_DIR/results.json"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
NC='\033[0m'

log_info() { echo -e "${CYAN}[INFO]${NC} $1"; }
log_ok() { echo -e "${GREEN}[OK]${NC} $1"; }
log_warn() { echo -e "${YELLOW}[WARN]${NC} $1"; }
log_error() { echo -e "${RED}[ERROR]${NC} $1"; }

# Check prerequisites
check_prereqs() {
    log_info "Checking prerequisites..."

    if ! command -v kubectl &> /dev/null; then
        log_error "kubectl not found"
        exit 1
    fi

    if ! kubectl cluster-info &> /dev/null; then
        log_error "Cannot connect to cluster"
        exit 1
    fi

    if ! [ -f "$AGENT_DIR/cub-scout" ]; then
        log_info "Building cub-scout..."
        (cd "$AGENT_DIR" && go build ./cmd/cub-scout)
    fi

    log_ok "Prerequisites OK"
}

# Apply all attacks
apply_attacks() {
    log_info "Applying lite attacks..."

    # Ensure HelmRepository exists
    kubectl apply -f - <<EOF
apiVersion: source.toolkit.fluxcd.io/v1
kind: HelmRepository
metadata:
  name: podinfo
  namespace: flux-system
spec:
  interval: 5m
  url: https://stefanprodan.github.io/podinfo
EOF

    # Apply lite attacks
    kubectl apply -f "$ATTACKS_DIR/lite-attacks.yaml" 2>&1 | while read line; do
        echo "  $line"
    done

    # Apply individual attack files
    for f in "$ATTACKS_DIR"/attack-lite-*.yaml; do
        if [ -f "$f" ]; then
            kubectl apply -f "$f" 2>&1 | sed 's/^/  /'
        fi
    done

    log_ok "Attacks applied"
}

# Wait for reconciliation
wait_reconcile() {
    local timeout=${1:-60}
    log_info "Waiting ${timeout}s for Flux reconciliation..."
    sleep "$timeout"
    log_ok "Wait complete"
}

# Run detection
run_scan() {
    log_info "Running cub-scout scan..."

    local json_output
    json_output=$("$AGENT_DIR/cub-scout" scan --threshold=10s --json 2>/dev/null)

    echo "$json_output" > "$RESULTS_FILE"

    # Parse results
    local total=$(echo "$json_output" | jq '.state.summary.total // 0')
    local silent=$(echo "$json_output" | jq '.state.summary.silentFailures // 0')
    local helm=$(echo "$json_output" | jq '.state.summary.helmReleaseStuck // 0')
    local kust=$(echo "$json_output" | jq '.state.summary.kustomizationStuck // 0')

    log_ok "Scan complete: $total findings ($silent silent, $helm HelmRelease, $kust Kustomization)"

    echo "$json_output"
}

# Generate report
generate_report() {
    log_info "Generating attack validation report..."

    if ! [ -f "$RESULTS_FILE" ]; then
        log_error "No results file found. Run --scan first."
        exit 1
    fi

    local json_output
    json_output=$(cat "$RESULTS_FILE")

    echo ""
    echo "═══════════════════════════════════════════════════════════════════"
    echo "CCVE-BOW Attack Validation Report"
    echo "═══════════════════════════════════════════════════════════════════"
    echo ""

    # List detected attacks
    echo "DETECTED (Gap validated - scanner finds these):"
    echo "───────────────────────────────────────────────"
    echo "$json_output" | jq -r '.state.findings[]? | "  [\(.severity | ascii_upcase)] \(.kind)/\(.name) - \(.ccveId) (\(.reason))"' 2>/dev/null || echo "  (none)"
    echo ""

    # List all HelmReleases and their status
    echo "HELMRELEASE STATUS:"
    echo "───────────────────"
    kubectl get helmreleases -n flux-system -o custom-columns='NAME:.metadata.name,READY:.status.conditions[?(@.type=="Ready")].status,REASON:.status.conditions[?(@.type=="Ready")].reason' 2>/dev/null | grep -E "lite-|attack-" | while read line; do
        if echo "$line" | grep -q "True"; then
            echo -e "  ${GREEN}✓${NC} $line"
        else
            echo -e "  ${RED}✗${NC} $line"
        fi
    done
    echo ""

    # List all Kustomizations and their status
    echo "KUSTOMIZATION STATUS:"
    echo "─────────────────────"
    kubectl get kustomizations -n flux-system -o custom-columns='NAME:.metadata.name,READY:.status.conditions[?(@.type=="Ready")].status,REASON:.status.conditions[?(@.type=="Ready")].reason' 2>/dev/null | grep -E "lite-|attack-" | while read line; do
        if echo "$line" | grep -q "True"; then
            echo -e "  ${GREEN}✓${NC} $line"
        else
            echo -e "  ${RED}✗${NC} $line"
        fi
    done
    echo ""

    # Summary
    echo "SUMMARY:"
    echo "────────"
    local total_hr=$(kubectl get helmreleases -n flux-system 2>/dev/null | grep -cE "lite-|attack-" || echo 0)
    local total_ks=$(kubectl get kustomizations -n flux-system 2>/dev/null | grep -cE "lite-|attack-" || echo 0)
    local detected=$(echo "$json_output" | jq '.state.summary.total // 0')
    local silent=$(echo "$json_output" | jq '.state.summary.silentFailures // 0')

    echo "  Total HelmReleases: $total_hr"
    echo "  Total Kustomizations: $total_ks"
    echo "  Detected issues: $detected"
    echo "  Silent failures found: $silent"
    echo ""

    # Classification
    echo "CLASSIFICATION:"
    echo "───────────────"
    echo "  Ready=True + Detected = SILENT FAILURE (gap validated)"
    echo "  Ready=False + Detected = STUCK STATE (expected detection)"
    echo "  Ready=True + Not Detected = POTENTIAL GAP (needs review)"
    echo ""
}

# Cleanup
cleanup() {
    log_info "Cleaning up attack resources..."

    kubectl delete -f "$ATTACKS_DIR/lite-attacks.yaml" --ignore-not-found 2>/dev/null || true

    for f in "$ATTACKS_DIR"/attack-lite-*.yaml; do
        if [ -f "$f" ]; then
            kubectl delete -f "$f" --ignore-not-found 2>/dev/null || true
        fi
    done

    log_ok "Cleanup complete"
}

# Main
main() {
    local do_apply=false
    local do_scan=false
    local do_report=false
    local do_cleanup=false
    local wait_time=60

    while [[ $# -gt 0 ]]; do
        case $1 in
            --apply)
                do_apply=true
                shift
                ;;
            --scan)
                do_scan=true
                shift
                ;;
            --report)
                do_report=true
                shift
                ;;
            --cleanup)
                do_cleanup=true
                shift
                ;;
            --wait)
                wait_time=$2
                shift 2
                ;;
            --all)
                do_apply=true
                do_scan=true
                do_report=true
                shift
                ;;
            *)
                echo "Usage: $0 [--apply] [--scan] [--report] [--cleanup] [--wait N] [--all]"
                exit 1
                ;;
        esac
    done

    check_prereqs

    if $do_cleanup; then
        cleanup
        exit 0
    fi

    if $do_apply; then
        apply_attacks
        wait_reconcile "$wait_time"
    fi

    if $do_scan; then
        run_scan
    fi

    if $do_report; then
        generate_report
    fi

    if ! $do_apply && ! $do_scan && ! $do_report; then
        echo "Usage: $0 [--apply] [--scan] [--report] [--cleanup] [--wait N] [--all]"
        echo ""
        echo "Examples:"
        echo "  $0 --all              # Apply, scan, and report"
        echo "  $0 --apply --wait 90  # Apply attacks, wait 90s"
        echo "  $0 --scan --report    # Scan and report (attacks already applied)"
        echo "  $0 --cleanup          # Remove attack resources"
    fi
}

main "$@"
