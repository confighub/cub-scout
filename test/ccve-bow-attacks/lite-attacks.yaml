# CCVE-BOW Lite Attack Suite
# 20 attacks using podinfo chart for fast validation
# All attacks are designed to be testable without external dependencies
---
# Attack 002: Empty directory Kustomization (80%)
apiVersion: source.toolkit.fluxcd.io/v1
kind: GitRepository
metadata:
  name: lite-source
  namespace: flux-system
spec:
  interval: 5m
  url: https://github.com/stefanprodan/podinfo
  ref:
    tag: 6.5.0
---
apiVersion: kustomize.toolkit.fluxcd.io/v1
kind: Kustomization
metadata:
  name: lite-002-empty-dir
  namespace: flux-system
spec:
  interval: 5m
  path: ./docs  # Directory exists but has no k8s manifests
  sourceRef:
    kind: GitRepository
    name: lite-source
  prune: true
---
# Attack 004: substituteFrom optional missing (85%)
apiVersion: kustomize.toolkit.fluxcd.io/v1
kind: Kustomization
metadata:
  name: lite-004-substitute
  namespace: flux-system
spec:
  interval: 5m
  path: ./kustomize
  sourceRef:
    kind: GitRepository
    name: lite-source
  prune: true
  postBuild:
    substituteFrom:
      - kind: ConfigMap
        name: missing-env-vars
        optional: true  # THE TRAP
    substitute:
      PODINFO_UI_MESSAGE: "Hello from substitute"
---
# Attack 011: Values merge clobber (90%)
apiVersion: v1
kind: ConfigMap
metadata:
  name: lite-011-overrides
  namespace: flux-system
data:
  values.yaml: |
    replicaCount: 1
    ui:
      message: "FROM CONFIGMAP"
---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: lite-011-clobber
  namespace: flux-system
spec:
  interval: 5m
  chart:
    spec:
      chart: podinfo
      version: "6.5.0"
      sourceRef:
        kind: HelmRepository
        name: podinfo
        namespace: flux-system
  values:
    replicaCount: 3
    ui:
      message: "FROM INLINE VALUES"  # User expects this
  valuesFrom:
    - kind: ConfigMap
      name: lite-011-overrides
      valuesKey: values.yaml
      # THE TRAP: inline values WIN over valuesFrom - user may not know
---
# Attack 012: Prune + CommonLabels race (85%)
apiVersion: kustomize.toolkit.fluxcd.io/v1
kind: Kustomization
metadata:
  name: lite-012-prune-race
  namespace: flux-system
spec:
  interval: 5m
  path: ./kustomize
  sourceRef:
    kind: GitRepository
    name: lite-source
  prune: true
  commonMetadata:
    labels:
      team: platform
      # THE TRAP: If label key changes, old resources become orphans
      # Old: environment: prod -> New: env: prod
      # Old resources with "environment" are pruned unexpectedly
---
# Attack 014: dependsOn across namespaces (80%)
apiVersion: v1
kind: Namespace
metadata:
  name: lite-014-other
---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: lite-014-dependency
  namespace: lite-014-other
spec:
  interval: 5m
  chart:
    spec:
      chart: podinfo
      version: "6.5.0"
      sourceRef:
        kind: HelmRepository
        name: podinfo
        namespace: flux-system
---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: lite-014-cross-ns
  namespace: flux-system
spec:
  interval: 5m
  dependsOn:
    - name: lite-014-dependency
      namespace: lite-014-other  # THE TRAP: Cross-namespace dependency
  chart:
    spec:
      chart: podinfo
      version: "6.5.0"
      sourceRef:
        kind: HelmRepository
        name: podinfo
        namespace: flux-system
---
# Attack 015: Chart version wildcard regression (75%)
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: lite-015-wildcard
  namespace: flux-system
spec:
  interval: 5m
  chart:
    spec:
      chart: podinfo
      version: ">=6.0.0"  # THE TRAP: May get unexpected major version bump
      sourceRef:
        kind: HelmRepository
        name: podinfo
        namespace: flux-system
---
# Attack 018: Kustomize patch no-op (92%)
# This requires a patch file in the source, so we simulate with inline patches
apiVersion: kustomize.toolkit.fluxcd.io/v1
kind: Kustomization
metadata:
  name: lite-018-patch-noop
  namespace: flux-system
spec:
  interval: 5m
  path: ./kustomize
  sourceRef:
    kind: GitRepository
    name: lite-source
  prune: true
  patches:
    - patch: |
        apiVersion: apps/v1
        kind: Deployment
        metadata:
          name: nonexistent-deployment  # THE TRAP: Target doesn't exist
        spec:
          replicas: 5
      target:
        kind: Deployment
        name: nonexistent-deployment
---
# Attack 020: targetPath replacement wrong (85%)
apiVersion: kustomize.toolkit.fluxcd.io/v1
kind: Kustomization
metadata:
  name: lite-020-replacement
  namespace: flux-system
spec:
  interval: 5m
  path: ./kustomize
  sourceRef:
    kind: GitRepository
    name: lite-source
  prune: true
  postBuild:
    substitute:
      IMAGE_TAG: "6.5.0"
      # THE TRAP: Substitution only works on ${VAR} patterns
      # If manifest uses $VAR or {{ .VAR }}, no substitution happens
---
# Attack 021: Hook deletion policy orphans (72%)
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: lite-021-hooks
  namespace: flux-system
spec:
  interval: 5m
  chart:
    spec:
      chart: podinfo
      version: "6.5.0"
      sourceRef:
        kind: HelmRepository
        name: podinfo
        namespace: flux-system
  install:
    remediation:
      retries: 3
  # THE TRAP: Default hook-delete-policy may leave pre-install jobs running
---
# Attack 023: PostRenderer silently skipped (88%)
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: lite-023-postrender
  namespace: flux-system
spec:
  interval: 5m
  chart:
    spec:
      chart: podinfo
      version: "6.5.0"
      sourceRef:
        kind: HelmRepository
        name: podinfo
        namespace: flux-system
  postRenderers:
    - kustomize:
        patches:
          - patch: |
              apiVersion: apps/v1
              kind: Deployment
              metadata:
                name: wrong-name  # THE TRAP: Name doesn't match
              spec:
                template:
                  spec:
                    containers:
                      - name: podinfo
                        env:
                          - name: ADDED_BY_POSTRENDER
                            value: "true"
            target:
              kind: Deployment
              name: wrong-name  # Doesn't match podinfo deployment
---
# Attack 028: PDB blocking evictions (85%)
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: lite-028-pdb-block
  namespace: flux-system
spec:
  minAvailable: 100%  # THE TRAP: Blocks ALL evictions
  selector:
    matchLabels:
      app.kubernetes.io/name: podinfo
---
# Attack 040: Orphaned finalizer (90%) - Already tested, include for completeness
apiVersion: v1
kind: ConfigMap
metadata:
  name: lite-040-orphan
  namespace: flux-system
  finalizers:
    - cleanup.nonexistent-operator.io/v1  # THE TRAP: Controller doesn't exist
data:
  message: "Cannot be deleted - orphaned finalizer"
---
# Attack 043: HelmRelease timeout too short (80%)
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: lite-043-timeout
  namespace: flux-system
spec:
  interval: 5m
  timeout: 10s  # THE TRAP: Too short for real deployments
  chart:
    spec:
      chart: podinfo
      version: "6.5.0"
      sourceRef:
        kind: HelmRepository
        name: podinfo
        namespace: flux-system
---
# Attack 046: Deployment replicas 0 (67%)
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: lite-046-zero-replicas
  namespace: flux-system
spec:
  interval: 5m
  chart:
    spec:
      chart: podinfo
      version: "6.5.0"
      sourceRef:
        kind: HelmRepository
        name: podinfo
        namespace: flux-system
  values:
    replicaCount: 0  # THE TRAP: Deployment exists but no pods
---
# Attack 047: ConfigMap update without pod restart (73%)
apiVersion: v1
kind: ConfigMap
metadata:
  name: lite-047-config
  namespace: flux-system
  annotations:
    note: "Changes to this ConfigMap won't restart pods unless using Reloader"
data:
  config.yaml: |
    debug: true
    # THE TRAP: Pods using this as volume won't restart on changes
---
# Attack 048: Secret rotation without restart (75%)
apiVersion: v1
kind: Secret
metadata:
  name: lite-048-secret
  namespace: flux-system
  annotations:
    note: "Pods won't pick up new secret values without restart"
type: Opaque
stringData:
  api-key: "original-key-value"
  # THE TRAP: Rotating this doesn't restart pods
---
# Attack 137: Helm upgrade outside Flux (90%)
# This attack requires manual intervention - just documenting the pattern
# Run: kubectl exec into cluster, helm upgrade a Flux-managed release
# Flux will detect drift on next reconcile
---
# Attack 136: kubectl apply drift (95%)
# This attack requires manual intervention - just documenting the pattern
# Run: kubectl apply a modified version of a Flux-managed resource
# Flux should detect and correct on next reconcile
